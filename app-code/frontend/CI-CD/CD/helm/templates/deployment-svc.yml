apiVersion: apps/v1
kind: Deployment
metadata:
  name: expense-frontend
  labels:
    app: expense-frontend
    tier: frontend
spec:
  replicas: {{ .Values.deployment.replicas }}
  selector:
    matchLabels:
      app: expense-frontend
      tier: frontend
  template:
    metadata:
      labels:
        app: expense-frontend
        tier: frontend
    spec:
      # ──────────────── InitContainer ────────────────
      initContainers:
        - name: wait-for-app
          image: curlimages/curl:8.1.2   # Tiny image with curl
          command:
            - sh
            - -c
            - |
              echo "Waiting for app to be ready on port 8080..."
              until curl -sSf http://expense-backend:8080/health >/dev/null 2>&1; do
                echo "App not ready yet, retrying in 3s..."
                sleep 3
              done
              echo "App is ready!"
      # ──────────────── App Container ────────────────
      containers:
        - name: expense-frontend-cont
          image: {{ .Values.image.registryUsername }}/expense-frontend:{{ .Values.image.version }}
          imagePullPolicy: Always
          ports:
            - name: frontend
              containerPort: 8080
      # ──────────────── Startup Probe ────────────────
      startupProbe:
        tcpSocket:
          port: 8080
        initialDelaySeconds: 10
        periodSeconds: 10
        timeoutSeconds: 10
        failureThreshold: 6
      # ──────────────── Readiness Probe ────────────────
      readinessProbe:
        tcpSocket:
          port: 8080
        initialDelaySeconds: 10
        periodSeconds: 10
        timeoutSeconds: 10
        failureThreshold: 3
      # ──────────────── Liveness Probe ────────────────
      livenessProbe:
        httpGet:
          path: /nginx-health
          port: 8080
        initialDelaySeconds: 10
        periodSeconds: 10
        timeoutSeconds: 10
        failureThreshold: 3
          
---
apiVersion: v1
kind: Service
metadata:
  name: expense-frontend
  labels:
    app: expense-frontend
    tier: frontend
spec:
  type: NodePort
  selector:
    app: expense-frontend
    tier: frontend
  ports:
  - name: expense-frontend
    protocol: "TCP"
    port: 8080
    targetPort: 8080
    nodePort: 32127
